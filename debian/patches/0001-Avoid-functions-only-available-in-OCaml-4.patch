From 68ac2b258395678ae315b4ffdb04a20d82e4a908 Mon Sep 17 00:00:00 2001
From: Thomas Leonard <talex5@gmail.com>
Date: Thu, 4 Jul 2013 11:27:02 +0100
Subject: [PATCH 1/2] Avoid functions only available in OCaml 4

Debian/unstable is still on OCaml 3.
---
 ocaml/support/common.ml | 30 ++++++++++++++++++++++++++----
 ocaml/support/utils.ml  |  2 +-
 2 files changed, 27 insertions(+), 5 deletions(-)

diff --git a/ocaml/support/common.ml b/ocaml/support/common.ml
index c79c926..e584290 100644
--- a/ocaml/support/common.ml
+++ b/ocaml/support/common.ml
@@ -12,10 +12,8 @@ type 'a result =
   | Failure of exn
 
 (** [a @@ b @@ c] is an alternative way to write [a (b (c))]. It's like [$] in Haskell. **)
-external ( @@ ) : ('a -> 'b) -> 'a -> 'b = "%apply"
-
-(** [a |> b] is an alternative way to write (b a) **)
-external (|>) : 'a -> ('a -> 'b) -> 'b = "%revapply";;
+(* external ( @@ ) : ('a -> 'b) -> 'a -> 'b = "%apply" *)
+let (@@) a b = a b
 
 type filepath = string
 type varname = string
@@ -82,3 +80,27 @@ let log_warning = Logging.log_warning
 let default d = function
   | None -> d
   | Some x -> x;;
+
+(** {2 Backported from OCaml 4} **)
+
+let trim s =
+  let is_space = function
+    | ' ' | '\012' | '\n' | '\r' | '\t' -> true
+    | _ -> false in
+  let open String in
+  let len = length s in
+  let i = ref 0 in
+  while !i < len && is_space (unsafe_get s !i) do
+    incr i
+  done;
+  let j = ref (len - 1) in
+  while !j >= !i && is_space (unsafe_get s !j) do
+    decr j
+  done;
+  if !i = 0 && !j = len - 1 then
+    s
+  else if !j >= !i then
+    sub s !i (!j - !i + 1)
+  else
+    ""
+
diff --git a/ocaml/support/utils.ml b/ocaml/support/utils.ml
index 9569beb..d5a3046 100644
--- a/ocaml/support/utils.ml
+++ b/ocaml/support/utils.ml
@@ -211,7 +211,7 @@ let parse_ini (system:system) fn path =
           handler := fn name
         else if Str.string_match re_key_value line 0 then
           let key = Str.matched_group 1 line in
-          let value = String.trim (Str.matched_group 2 line) in
+          let value = trim (Str.matched_group 2 line) in
           !handler (key, value)
       done
     with End_of_file -> () in
-- 
1.8.3.1

